from pathlib import Path
import numpy as np
from re import search
from math import prod


def get_edges(tile):
    return [list(tile[0, :]), list(tile[9, :]), list(tile[:, 0]), list(tile[:, 9])]


def flipped_edges(edges: list):
    return [e[::-1] for e in edges]


filename = "input_20.txt"
all_tiles = {}
with Path(filename).open() as file:
    for block in file:
        tile = []
        t_num = int(search(r'(\d+)', block).group(1))
        while line := file.readline().strip():
            new_line = line.replace('.', '0').replace('#', '1')
            tile.append(list(map(int, new_line)))
        all_tiles[t_num] = np.array(tile)

all_edges = []
for tile in all_tiles.values():
    edges = get_edges(tile)
    all_edges += edges
    all_edges += flipped_edges(edges)

corner_ids = []
for tile in all_tiles:
    edges = get_edges(all_tiles[tile])
    s = 0
    for e in edges:
        s += all_edges.count(e)
    if s == 6:
        corner_ids.append(tile)
print(prod(corner_ids))

# PART 2
corner_ids = [3557]
start_corner = all_tiles.pop(corner_ids[0])  # oriented as top left corner
bottom_edges = [list(start_corner[9, :])]
right_edge = list(start_corner[:, 9])
image = start_corner[1:9, 1:9]


def add_tile_to_right(edge, all_tiles, image):
    id, tile = rotate_tile_to_append_from_right(edge, all_tiles)
    bottom_edges.append(list(tile[9, :]))
    right_edge = list(tile[:, 9])
    image = np.append(image, tile[1:9, 1:9], axis=1)
    del (all_tiles[id])
    return right_edge, image


def rotate_tile_to_append_from_right(edge, all_tiles):
    for id, tile in all_tiles.items():
        if edge == list(tile[:, 0]):
            pass
        elif edge == list(tile[9, :]):
            tile = np.rot90(tile, k=-1)
        elif edge == list(tile[:, 9])[::-1]:
            tile = np.rot90(tile, k=2)
        elif edge == list(tile[0, :])[::-1]:
            tile = np.rot90(tile, k=1)
        # fliped tiles
        elif edge == list(tile[:, 0])[::-1]:
            tile = np.flipud(tile)
        elif edge == list(tile[9, :])[::-1]:
            tile = np.flipud(np.rot90(tile, k=-1))
        elif edge == list(tile[:, 9]):
            tile = np.flipud(np.rot90(tile, k=2))
        elif edge == list(tile[0, :]):
            tile = np.flipud(np.rot90(tile, k=1))
        else:
            continue
        break
    return id, tile


def add_tile_to_down(edge, all_tiles):
    id, tile = rotate_tile_to_append_from_right(edge[::-1], all_tiles)
    tile = np.rot90(tile, k=-1)
    bottom_edges[0] = list(tile[9, :])
    right_edge = list(tile[:, 9])
    del (all_tiles[id])
    return right_edge, tile[1:9, 1:9]


# first row
for _ in range(11):
    right_edge, image = add_tile_to_right(right_edge, all_tiles, image)

# next rows
for _ in range(11):
    right_edge, row_image = add_tile_to_down(bottom_edges[0], all_tiles)

    for _ in range(11):
        right_edge, row_image = add_tile_to_right(right_edge, all_tiles, row_image)

    image = np.append(image, row_image, axis=0)


# find monsters and rotation
monster_array = np.array([
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0],
    [1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1],
    [0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0]
])
m, n = monster_array.nonzero()
monster = list(zip(m, n))  # coordinates in array
# m, n = monster_array.shape
total = sum(sum(image))

stop = False
monster_count = 0
image = np.flipud(image)
for k in range(0, 4):
    if stop:
        break
    print(f'rotation {k}')
    image = np.rot90(image, k=k)
    for i in range(len(image) - 20):
        for j in range(len(image) - 3):
            if all([image[j:j + 3, i:i + 20][x] for x in monster]):
                for x, y in monster:
                    image[x+j, y+i] = 2
                monster_count += 1
                stop = True


print(f'monsters: {monster_count}')
print(f'#: {total - monster_count * len(monster)}')

for line in image:
    print("".join([str(x) for x in line]).replace('0', '.').replace('1', '+').replace('2', 'O'))

'''
...+....+.....+...++....................++.+....+....+...............+.....++...+...++..+...+...
++.........++......+..++..+..O.....++++..+....+...+.+..................++.++........+.++.+......
......++..+O+.+.OO..+.OO...+OOO...........+..+.+..+.......++...+.+........+.+.+.................
..+..+.+...+O..O..O..O..O..O...+........+..++..+....+++.+.......+...+.+...+.+....+...+..+.......
.+...+....++..++...+..+.+++++..+....+.+...+..++.+..++..+.+.+.....+..++...+.......+...+....+..+..
++................++..+++...++.......++......+.+.......++...++.....+.........++.........+..++...
+.......+..++.....+.+..++...........+...+...++.....+.+..++....+......+.......++..+.......+++.+.+
........++..+.++....++O.........+....+....+........+.+...+++.+..+..+..++.+.....+...........O....
....O++++OO....OO....OOO...+....++......+...+.+..+..++.....+..++...+.....O..+.OO+.+.OO.+..OOO.+.
.....O..O..O+.O.+O+.O........+......+..+.+....+..+...........+...++...++..O+.O+.O.+O..O.+O..+...
..........+............+...+...+.....+.....+......+.........+.+....+.....+..+.....+++.+...+..+..
..+++..........+..++......++.......+..........+..+............+.+..+..+........+..++...++.+.....
....+..+.+.++.....++..+......+.O......+..++.+.........++........+.++..........++.....++.....++..
........+...+O.++.OO....OO..+.OOO.....+...+...+.....+......+....+...++..+..+...++..O...++..+....
++.........+.+O..O..O..O.+O..O..++...........++..+..+.+..+..+....O..++OO....OO.++.OOO.......+...
.....+.......++............+......++........++..++...+...+.+...+..O..O..O.+O..O..O...++.........
...+++..+....++........+.........+.+........++..+.+....+...+..+...+..+.+.+++..+.+.+..+.+.+..+++.
.+++......+..+++..++.....+....+..+...+.+......+.......+..++++..+...++...+....+...+..++..+..+....
...+..........+..+...++.......+......O...++.+....+...++...+.+.++..+....++..+.+..++.++...+.....++
.+...............++O..++OO+.+.OO+...OOO+...+.........+..+.+.......+..+........+++..+..........+.
..++......++...+....O..O..O..O..O.+O..........+......+..........+......++..........++.....+..+..
......+..+..++....+.+.++.+...+.+..+....+....+....+.......+....+.++.++...........+..+...+.....+++
+...............+.+....+.+.+......+.....+.......+...+.+....+.....+.................+....+....+..
...+.+...+...+.++.+..++...++.++...+..++...+..++.......+...+...+......+.+......+...+.....+...+...
..++....++......++..+..+....+.++++.+..+...............+..+.++..+..+....+..+.....+.+...........+.
+.+........+.....+...++....++....+...+.O..+.+.+....+.+......+...++.+..+.+..++.+.++..+...+..+..+.
.+++....+++....+..+..O....OO....OO++++OOO....+.+..+.+......+++...+..+.............+..+.+.....+..
...............+.+.+..O..O+.O..O+.O++O..+..+..+.....++.+....+......+.............+.............+
.........+...++.......+..........+................+...+...+.+.++.+........+++........+.+..++.++.
........+.++.+.+.......+...............+..............+...........+....+..+...........+++...+...
+.+..+.+...+....+..+..+....+....++.+...++.+....+.+++..+...++....+....+..+.+........+......+.....
..++......+.+..+.......+.+....+++++....+...............+.............+++........++..+++...+.+...
..++.++..+++....+.+....+.+..+..+.....++.+..+..+...++.....+...+..+..+.................+.....+++..
......+....+.....+.++.......+....++.....+.+.+...+.......++...+.+.++.+.......+.+........++.......
+.++...+.....+...+..........+.....++.............+....+......+.....+..+......++.....++......+...
..+..+...+....+.+.++.++..................+.+...+++.............+........+........+..++....+.....
....+.......+.+.+.+........+....O........+.+...++.......+.++...++++.+.....+.+..+...+.+.+......++
......+.....+.O+++.OO....OO...+OOO....+..+.+...+......+.++.....+....+.+...+.............+....+..
......+........O..O..O..O+.O..O..++....+.......+......+........++......+......O+.+...+++.++.....
......+......+.+..........++......+..+..++++..+........+....O....OO..+.OO+...OOO.......+.++.+..+
+++.....+.....++....+.....+........+..++........++..++....+..O..O..O..O++O..O.+...+...++........
.....++++.+...+.+..+...+.......+...++..+...+.+...........+....+.........++......+.+.............
..+..+..+++...++..++..+...++.+.................+....+........+...+...+...+....+..+........++....
++........++.++........+....++...........+....+....+.......+...+..+...++.....+............++..++
...+.....+....+...+......+.+..++.....+....+......+.+....+.++.....+....+.....+.....+.......+.+...
+.....++.....+..+.+.......++.+.+......+......+....++++.+......++++....+...+++..++......+.+...+..
+......++++.++++.+....++..++....+...+.....+.+.+.+..O..+......++.+..........++........++.+..+....
+...+...+++..+....++.+...+.+++.+.O.++.OO....OO..+.OOO+.+....+.......+............+.+............
............+.......++.....+..+.+.O++O..O.+O..O..O+........+..+........+.+.++..+............+++.
......+...+.++.....+.+...+...+..+............+.+....++..++..++.+.+....+.......+.+..+.+++....++..
.+.........+..+........++...+.++++...+.....++...+....+..............+.+..++......++.++....++++.+
+..+...++.+..+.......+...++.......+..+.+...+.O+........+..+....+..+....+....+.+....+.+...+...+..
.+..++...+.+++....+.....+.+O+...OO....OO....OOO..++....+.........+.+......+.+.....+.++...+..+.++
.+.+..+.......+.....++.....+O..O..O+.O..O..O+......+.++++.......+....++.+....+.+..++..+.+....+..
..........+.....+..+.+...+++.+.+...+.++...++....++..+.+...+.....++.+....+.+...+...........+..++.
.+.+..+.....++++.....++...++...+......+...++.++.+..+.....+.............+......++...+++....++....
.......+.+.+.+......+.+.......O...++..+.........+....O..+....+.+....+++.........++..+.+.........
+.+..+.+....O....OO.+..OO++..OOO+..O+...OO...+OO....OOO...+...++..+.+...+..+.++........+.+......
............+O.+O..O..O+.O..O......+O..O..O+.O..O.+O..........+.+.++..+.+..+..+.++.++........+..
.++.++.+.+...+...++..+....+.+.....+++.....+...+...+........+........+........+..+........++.....
.....+.........++...+....+.........++.+..+......++.+...+........++...+...+....+....++...+...+...
.+.....+++.+........O...+....+.++...+........+..........+.........+...+....+O...................
.+O+.+.OO+..+OO...+OOO......+......+.+...++....+..++......O..+.OO.+..OO....OOO+.+......+..+.....
.+.O..O.+O++O.+O..O..+.+.+.+.........+........+...++..++...O.+O+.O..O..O.+O.......+.....+...+...
+.........++.++..........++...++........+.+..++O+...........++..+.......+..+...+........+..++...
+.+...+......+.+......+....+.O++..OO..+.OO+...OOO.+......+.+.....+..+..+..+..++........++.......
..+..+....++...+.............+O.+O+.O..O..O.+O.+..+..++........+..+.+..+.........++.+.+..++.+.++
...+...++.+.+.......++...++...+....+....+...............+.+.......+++O...+..+.........++.......+
..+.+............+...+++.....++.+...+.....+..++...+O...+OO....OO+...OOO+......+..+.+.++...+.....
.....+...+.......+.+..++.++...........+.......++....O..O..O++O..O++O.+..+........+.....+....+...
..........+....+..................+.+..+..+.+.+.+..+...+..+...+..+.......+..+++..+..+...+..+....
+++.+.....+.+.++...+....+...+....+....+............+........++..++....++.+.......+..++..+....+..
+......++.......+.....+...++...+.....+..+..+.....+..............+........+.......+...++....+....
.+....+...+.....+....++.+....+..+...++.++..+..........+...........+....+..+++...+.............+.
.........+..++++........+.............++...+++.+..+..........+++....+++.+++........++.++.++..+.+
+.++...+........++.+.........++++...........+++.+............+..+..+..........++........++.+....
+...+.+.....+.++.......O++.....+....++.+..+..+............+...+...+.+..++...+.++.....+...O...+..
...+.O....OO.+..OO.+.+OOO.....+.++.+....+...+...+.+....+....++....O..++O....OO....OO+...OOO+++..
.....+O.+O+.O..O..O..O........+........+....+...O....OO.+..OO++..OOO....O..O.+O..O+.O++O+.....+.
.+.+.++.+.....+...............+..+++.+.+.++....+.O..O.+O++O..O..O.+.....+..+.....+...........+++
+...........+....+++.....++..+.....+......++.....+...................+..........+.+.....++......
................+...+++..+...........++........+........++.........+..+.+..+.+.+...++.+......+..
.+.+..++....+.............+.....++................++..+..+.++..+++......+...+.....+.+...........
...+.........+.+.+.......+..O........+.+..+...+..........+...+..+..........+...+............+...
......++.+O....OO..+.OO....OOO..........+...+...+....+...+....+....+....+.+.+.......+.+++..+.+++
..+.....+..O..O..O..O..O+.O++....+..........+..+.++....+....+...+.+....+.+.....+.+.........+..+.
.....++.+.+..+....+.............+....++..+........++......++..O.+......++++.........+O...+...+..
..+..+.+.+.+..+...+...+.++..+.+.++..+.+.+...O.+.+OO+...OO....OOO..+O+.+.OO..+.OO....OOO.........
...+++.....................+..+...+......+...O..O.+O..O.+O..O.......O..O++O..O.+O+.O.+.......++.
.+...+.++....+..+.....+.+......+...+.+...+.+..+..+....+...+++.........++...+............+.......
+....+...+++...+....+..+.+.........+..+++.+++....+.........++.+..+.+++....+...+++.....+..+...+..
.+..............+.......+..+..+..+.....+.+.....+.....+..+..+...+...+......+.....+.+..++.....++..
..++.........+.+..+..........+..+....+.+.....+........+...+....+....+..+......+..+....+.......+.
+........................+.+......+..+..+.....+.........+.....+..+........+...+....+.+.....++...
..+.+..++..++.+............+........+....+....+..+.+...++.....+..+..++.....+..+...+...+...+....+
...........+.+.+.....+....+....++....+.+..........+..+...+..+..+.++.+++..+..........+...++..++++
'''